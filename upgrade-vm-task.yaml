---
- name: Get VM instance info for {{ vm.metadata.name }}
  kubernetes.core.k8s_info:
    api_version: kubevirt.io/v1
    kind: VirtualMachineInstance
    name: "{{ vm.metadata.name }}"
    namespace: "{{ vm.metadata.namespace }}"
  register: vmi_info

- name: Skip if VM is not running
  debug:
    msg: "VM {{ vm.metadata.name }} is not running, skipping upgrade"
  when: vmi_info.resources | length == 0

- name: Get VM IP address
  set_fact:
    vm_ip: "{{ vmi_info.resources[0].status.interfaces[0].ipAddress }}"
  when: vmi_info.resources | length > 0

- name: Add VM to in-memory inventory
  add_host:
    name: "{{ vm.metadata.name }}"
    ansible_host: "{{ vm_ip }}"
    ansible_user: "{{ ssh_user }}"
    ansible_ssh_common_args: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
    vm_namespace: "{{ vm.metadata.namespace }}"
  when: vmi_info.resources | length > 0

- name: Upgrade VM {{ vm.metadata.name }}
  delegate_to: "{{ vm.metadata.name }}"
  when: vmi_info.resources | length > 0
  block:
    - name: Wait for SSH to become available
      wait_for_connection:
        timeout: 60
        delay: 5

    - name: Gather facts from VM
      setup:

    - name: Ensure host is using DNF package manager
      fail:
        msg: "This playbook requires a DNF-based system (RHEL 8+, Fedora, Rocky Linux, AlmaLinux, etc.)"
      when: ansible_pkg_mgr != 'dnf'

    - name: Clean DNF cache
      become: true
      command: dnf clean all
      when: clean_cache | bool

    - name: Check available updates
      become: true
      command: dnf check-update
      register: dnf_check
      failed_when: dnf_check.rc not in [0, 100]
      changed_when: false

    - name: Display available updates for {{ vm.metadata.name }}
      debug:
        msg: "{{ dnf_check.stdout_lines }}"
      when: dnf_check.rc == 100

    - name: No updates available for {{ vm.metadata.name }}
      debug:
        msg: "No updates available for VM {{ vm.metadata.name }}"
      when: dnf_check.rc == 0

    - name: Upgrade all packages on {{ vm.metadata.name }}
      become: true
      dnf:
        name: "*"
        state: latest
        skip_broken: "{{ skip_broken }}"
      register: dnf_upgrade
      when: dnf_check.rc == 100

    - name: Display upgrade results for {{ vm.metadata.name }}
      debug:
        msg:
          - "VM: {{ vm.metadata.name }}"
          - "Packages upgraded: {{ dnf_upgrade.results | default([]) | length }}"
      when: dnf_upgrade is changed

    - name: Check if kernel was upgraded
      become: true
      shell: |
        LATEST_KERNEL=$(rpm -q kernel --last | head -n1 | awk '{print $1}')
        RUNNING_KERNEL="kernel-$(uname -r)"
        if [ "$LATEST_KERNEL" != "$RUNNING_KERNEL" ]; then
          echo "reboot_needed"
        else
          echo "no_reboot_needed"
        fi
      register: kernel_check
      changed_when: false
      when: dnf_upgrade is changed

    - name: Reboot VM if needed
      become: true
      reboot:
        msg: "Rebooting {{ vm.metadata.name }} after system upgrade"
        reboot_timeout: "{{ reboot_timeout }}"
        pre_reboot_delay: 5
      when:
        - reboot_after_upgrade | bool
        - dnf_upgrade is changed
        - kernel_check.stdout == "reboot_needed"

    - name: Wait for VM to come back online
      wait_for_connection:
        delay: 30
        timeout: "{{ reboot_timeout }}"
      when:
        - reboot_after_upgrade | bool
        - dnf_upgrade is changed
        - kernel_check.stdout == "reboot_needed"

    - name: Verify system is running after reboot
      become: true
      command: uptime
      register: uptime_result
      when:
        - reboot_after_upgrade | bool
        - dnf_upgrade is changed

    - name: Display final status for {{ vm.metadata.name }}
      debug:
        msg:
          - "VM {{ vm.metadata.name }} upgrade completed successfully"
          - "Uptime: {{ uptime_result.stdout | default('N/A') }}"
          - "Kernel version: {{ ansible_kernel }}"
      when: dnf_upgrade is changed
