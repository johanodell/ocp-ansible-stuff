---
# ClusterRole to manage AAP resources
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: aap-resource-manager
rules:
  # Allow managing AnsibleProject resources
  - apiGroups:
      - tower.ansible.com
    resources:
      - ansibleprojects
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch

  # Allow managing JobTemplate resources
  - apiGroups:
      - tower.ansible.com
    resources:
      - jobtemplates
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch

  # Allow managing AnsibleJob resources (for the PostSync hook)
  - apiGroups:
      - tower.ansible.com
    resources:
      - ansiblejobs
    verbs:
      - create
      - delete
      - get
      - list
      - patch
      - update
      - watch

  # Allow reading status subresources
  - apiGroups:
      - tower.ansible.com
    resources:
      - ansibleprojects/status
      - jobtemplates/status
      - ansiblejobs/status
    verbs:
      - get
      - list
      - watch

---
# RoleBinding to grant ArgoCD permissions in the aap namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: argocd-aap-resource-manager
  namespace: aap
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: aap-resource-manager
subjects:
  - kind: ServiceAccount
    name: openshift-gitops-argocd-application-controller
    namespace: openshift-gitops
